<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>NiYien Telemetry Stats</title>
  
  <!-- CSS Framework & Libs -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet.heat/dist/leaflet-heat.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
  
  <style>
    #map { height: 500px; width: 100%; border-radius: 0.5rem; z-index: 1; }
    .chart-container { position: relative; height: 300px; width: 100%; }
    [v-cloak] { display: none; }
  </style>
</head>
<body class="bg-gray-100 text-gray-800">

<div id="app" v-cloak class="min-h-screen p-4 md:p-8">
  <!-- Header & Controls -->
  <header class="mb-8 flex flex-col md:flex-row justify-between items-center gap-4">
    <div>
      <h1 class="text-3xl font-bold text-blue-600">NiYien Stats</h1>
      <p class="text-sm text-gray-500">Telemetry Dashboard</p>
    </div>
    
    <div class="flex flex-col md:flex-row items-center gap-2">
      <div class="flex gap-2 bg-white p-1 rounded-lg shadow">
         <input 
           type="password" 
           v-model="token" 
           placeholder="Token (Optional)" 
           class="px-3 py-2 rounded text-sm border-none focus:ring-0 w-32"
           @change="saveToken"
         >
         <div class="w-px bg-gray-200 my-1"></div>
         <button 
            v-for="d in durations" 
            :key="d.val"
            @click="loadStats(d.val)"
            :class="['px-4 py-2 rounded transition-colors text-sm', duration === d.val ? 'bg-blue-600 text-white' : 'hover:bg-gray-100']"
         >
            {{ d.label }}
         </button>
      </div>
    </div>
  </header>

  <!-- Error State -->
  <div v-if="error" class="bg-red-100 border-l-4 border-red-500 text-red-700 p-4 mb-8" role="alert">
    <p>{{ error }}</p>
  </div>

  <!-- Loading State -->
  <div v-if="loading" class="text-center py-20">
    <div class="animate-spin h-10 w-10 border-4 border-blue-500 border-t-transparent rounded-full mx-auto mb-4"></div>
    <p class="text-gray-500">Crunching numbers...</p>
  </div>

  <div v-if="!loading && data" class="space-y-8">
    
    <!-- KPI Cards -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
      <kpi-card title="Total Opens" :value="totalOpens" icon="ðŸš€"></kpi-card>
      <kpi-card title="Active Cities" :value="Object.keys(data.city_totals || {}).length" icon="ðŸŒ"></kpi-card>
      <kpi-card title="Camera Brands" :value="Object.keys(data.brand_totals || {}).length" icon="ðŸ“·"></kpi-card>
      <kpi-card title="Active Models" :value="Object.keys(data.model_totals || {}).length" icon="ðŸ”¢"></kpi-card>
    </div>

    <!-- Map Section -->
    <div class="bg-white p-4 rounded-xl shadow-sm">
      <h2 class="text-xl font-semibold mb-4">User Distribution Heatmap</h2>
      <div id="map"></div>
    </div>

    <!-- Main Charts Row -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
      <!-- Brands -->
      <div class="bg-white p-6 rounded-xl shadow-sm">
        <h3 class="text-lg font-semibold mb-4">Camera Brands</h3>
        <div class="chart-container">
          <canvas id="brandChart"></canvas>
        </div>
      </div>
      
      <!-- Top Models -->
      <div class="bg-white p-6 rounded-xl shadow-sm">
        <h3 class="text-lg font-semibold mb-4">Top 10 Models</h3>
        <div class="chart-container">
          <canvas id="modelChart"></canvas>
        </div>
      </div>
    </div>

    <!-- Secondary Charts Row -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
      <!-- User Retention / Usage Freq -->
      <div class="bg-white p-6 rounded-xl shadow-sm">
        <h3 class="text-lg font-semibold mb-4">Weekly User Frequency (Retention)</h3>
        <div class="chart-container">
          <canvas id="usageChart"></canvas>
        </div>
        <p class="text-xs text-gray-400 mt-2 text-center">
          Heavy Users (6+ opens/week): {{ data.weekly_usage?.heavy_users || 0 }} 
          ({{ ((data.weekly_usage?.heavy_ratio || 0) * 100).toFixed(1) }}%)
        </p>
      </div>

      <!-- Languages -->
      <div class="bg-white p-6 rounded-xl shadow-sm">
        <h3 class="text-lg font-semibold mb-4">Language Distribution</h3>
        <div class="chart-container">
          <canvas id="langChart"></canvas>
        </div>
      </div>
    </div>

    <!-- Detailed City Breakdown -->
    <div class="bg-white p-6 rounded-xl shadow-sm overflow-hidden">
      <h3 class="text-lg font-semibold mb-4">City & Model Breakdown</h3>
      <div class="overflow-x-auto">
        <table class="w-full text-left border-collapse">
          <thead>
            <tr class="bg-gray-50 border-b">
              <th class="p-3">City</th>
              <th class="p-3">Total Opens</th>
              <th class="p-3">Top Brand</th>
              <th class="p-3">Top Model</th>
            </tr>
          </thead>
          <tbody>
            <tr v-for="city in topCities" :key="city.name" class="border-b hover:bg-gray-50">
              <td class="p-3 font-medium">{{ city.name }}</td>
              <td class="p-3">{{ city.count }}</td>
              <td class="p-3 text-sm text-gray-600">{{ city.topBrand }}</td>
              <td class="p-3 text-sm text-gray-600">{{ city.topModel }}</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

  </div>
</div>

<script>
const { createApp, ref, computed, onMounted, watch } = Vue;

const App = {
  setup() {
    const error = ref(null);
    const loading = ref(false);
    const data = ref(null);
    const duration = ref('7');
    const token = ref('');
    const durations = [
      { label: '7D', val: '7' },
      { label: '14D', val: '14' },
      { label: '30D', val: '30' },
      { label: 'All', val: 'all' }
    ];

    let map = null;
    let heatLayer = null;
    let charts = {};

    // Mapbox/OSM Init
    const initMap = () => {
      if (map) return;
      map = L.map('map').setView([20, 0], 2);
      L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
        attribution: '&copy; OpenStreetMap &copy; CartoDB',
        subdomains: 'abcd',
        maxZoom: 19
      }).addTo(map);
    };

    const updateMap = (cityTotals) => {
      if (!map) initMap();
      
      const heatPoints = [];
      // Mock lookup for demonstration - REPLACE with real lat/lon in production
      // or expand the hardcoded list significantly.
      const cityCoords = {
        "Shanghai": [31.2304, 121.4737], "Beijing": [39.9042, 116.4074],
        "London": [51.5074, -0.1278], "New York": [40.7128, -74.0060],
        "Tokyo": [35.6762, 139.6503], "Singapore": [1.3521, 103.8198],
        "Sydney": [-33.8688, 151.2093], "Paris": [48.8566, 2.3522],
        "Berlin": [52.5200, 13.4050], "Moscow": [55.7558, 37.6173],
        "Los Angeles": [34.0522, -118.2437], "Toronto": [43.6510, -79.3470],
        "Hong Kong": [22.3193, 114.1694], "Taipei": [25.0330, 121.5654],
        "Seoul": [37.5665, 126.9780], "Bangkok": [13.7563, 100.5018],
        "Dubai": [25.2048, 55.2708], "Mumbai": [19.0760, 72.8777],
        // ... Add more as needed
      };

      Object.entries(cityTotals).forEach(([city, count]) => {
        // Decode URI component just in case
        const decCity = decodeURIComponent(city);
        const coords = cityCoords[decCity];
        
        if (coords) {
          // Add point with intensity based on log of count
          const intensity = Math.min(count * 10, 1000); 
          heatPoints.push([coords[0], coords[1], intensity]);
        }
      });

      if (heatLayer) map.removeLayer(heatLayer);
      if (heatPoints.length > 0) {
        heatLayer = L.heatLayer(heatPoints, { radius: 25, title: 'Heatmap' }).addTo(map);
      }
    };

    const loadStats = async (days) => {
      duration.value = days;
      loading.value = true;
      error.value = null;
      
      try {
        const headers = token.value ? { "X-Stats-Token": token.value } : {};
        const res = await fetch(`/api/telemetry-stats?days=${days}`, { headers });
        if (res.status === 401) {
             throw new Error("Unauthorized: Please enter a valid Token");
        }
        if (!res.ok) throw new Error(`API Error: ${res.status}`);
        const json = await res.json();
        data.value = json;
        
        // Wait for DOM update
        await Vue.nextTick();
        // Double check if canvas exists, sometimes nextTick is too fast for complex v-if
        setTimeout(() => {
          renderCharts(json);
          updateMap(json.city_totals || {});
        }, 100);
      } catch (e) {
        error.value = e.message;
        console.error(e);
      } finally {
        loading.value = false;
      }
    };

    const renderCharts = (stats) => {
      destroyCharts();
      
      try {
        // Brands
        if (document.getElementById('brandChart')) {
          charts.brand = createChart('brandChart', 'doughnut', stats.brand_totals, 'Brands');
        }
        
        // Models (Top 10)
        if (document.getElementById('modelChart')) {
          const topModels = getTopK(stats.model_totals, 10);
          charts.model = createChart('modelChart', 'bar', topModels, 'Models');
        }

        // Weekly Usage
        if (document.getElementById('usageChart') && stats.weekly_usage && stats.weekly_usage.buckets) {
           charts.usage = new Chart(document.getElementById('usageChart'), {
            type: 'bar',
            data: {
              labels: Object.keys(stats.weekly_usage.buckets),
              datasets: [{
                label: 'Users',
                data: Object.values(stats.weekly_usage.buckets),
                backgroundColor: '#3b82f6'
              }]
            }
          });
        }

        // Langs
        if (document.getElementById('langChart')) {
          charts.lang = createChart('langChart', 'pie', stats.language_totals, 'Language');
        }
      } catch (e) {
        console.warn("Chart render failed", e);
      }
    };

    const createChart = (id, type, dataObj, label) => {
      const sorting = Object.entries(dataObj || {})
        .sort((a, b) => b[1] - a[1]);
      
      if (id === 'modelChart') { // Keep specifically top 10 for bar
         // already sliced in caller
      }

      const labels = sorting.map(x => decodeURIComponent(x[0]));
      const values = sorting.map(x => x[1]);

      return new Chart(document.getElementById(id), {
        type: type,
        data: {
          labels: labels,
          datasets: [{
            label: label,
            data: values,
            backgroundColor: [
              '#3b82f6', '#10b981', '#f59e0b', '#ef4444', 
              '#8b5cf6', '#ec4899', '#6366f1', '#14b8a6'
            ],
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { position: 'bottom' } }
        }
      });
    };

    const destroyCharts = () => {
      Object.values(charts).forEach(c => c && c.destroy());
      charts = {};
    };

    const getTopK = (obj, k) => {
      return Object.fromEntries(
        Object.entries(obj || {}).sort((a, b) => b[1] - a[1]).slice(0, k)
      );
    };

    const totalOpens = computed(() => {
      if (!data.value?.city_totals) return 0;
      return Object.values(data.value.city_totals).reduce((a, b) => a + b, 0);
    });

    const topCities = computed(() => {
        if (!data.value?.city_totals) return [];
        
        // Use result of brand_totals and model_city_totals to find top brand/model per city
        const cities = Object.entries(data.value.city_totals)
            .sort((a, b) => b[1] - a[1]) // Sort by count
            .slice(0, 50); // Top 50

        return cities.map(([city, count]) => {
            const cityName = decodeURIComponent(city);
            
            // Find top Brand for this city
            const cityBrands = data.value.city_brand_totals?.[city] || {};
            const topBrandEntry = Object.entries(cityBrands).sort((a, b) => b[1] - a[1])[0];
            const topBrand = topBrandEntry ? decodeURIComponent(topBrandEntry[0]) : '-';

            // Find top Model for this city
            // Note: Currently API returns Model totals globally, 
            // OR if we implemented model_city_totals we can use it.
            // We successfully added model_city_totals in backend.
            const cityModels = data.value.model_city_totals?.[city] || {};
            const topModelEntry = Object.entries(cityModels).sort((a, b) => b[1] - a[1])[0];
            const topModel = topModelEntry ? decodeURIComponent(topModelEntry[0]) : '-';

            return {
                name: cityName,
                count: count,
                topBrand: topBrand,
                topModel: topModel
            };
        });
    });

    const saveToken = () => {
      localStorage.setItem('telemetry_stats_token', token.value);
      loadStats(duration.value); // Reload with new token
    };

    onMounted(() => {
      const savedToken = localStorage.getItem('telemetry_stats_token');
      if (savedToken) {
        token.value = savedToken;
      }
      // Delay initial load slightly or allow immediate if token exists
      loadStats('7');
    });

    return {
      duration, durations, loadStats,
      error, loading, data,
      totalOpens, topCities, 
      token, saveToken // Export new props
    };
  }
};

const app = createApp(App);
app.component('kpi-card', {
  props: ['title', 'value', 'icon'],
  template: `
    <div class="bg-white p-6 rounded-xl shadow-sm flex items-center space-x-4">
      <div class="text-4xl">{{ icon }}</div>
      <div>
        <p class="text-sm text-gray-500 font-medium uppercase">{{ title }}</p>
        <p class="text-2xl font-bold text-gray-900">{{ value }}</p>
      </div>
    </div>
  `
});
app.mount('#app');
</script>
</body>
</html>
